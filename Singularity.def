Bootstrap: docker
From: pytorch/pytorch:latest

%post
    # Update package lists
    apt-get update && apt-get install -y \
        build-essential \
        git \
        && rm -rf /var/lib/apt/lists/*

    # Install Python dependencies
    pip install --no-cache-dir \
        cython \
        numpy \
        aedat \
        datasets \
        huggingface_hub

    # Set up working directory
    mkdir -p /workspace

%environment
    export PYTHONPATH=/workspace:$PYTHONPATH
    export HF_HOME=/scratch/aplesner/.cache/huggingface
    export TRANSFORMERS_CACHE=/scratch/aplesner/.cache/huggingface/transformers
    export HF_DATASETS_CACHE=/scratch/aplesner/.cache/huggingface/datasets

%runscript
    cd /workspace
    exec python process_raw_datasets.py "$@"

%labels
    Author aplesner
    Version 1.0
    Description Event-based datasets processing container with PyTorch

%help
    This container provides a PyTorch environment for processing event-based datasets.

    Usage:
        # Build the container
        singularity build event-datasets.sif Singularity.def

        # Run interactively
        singularity shell event-datasets.sif

        # Run the default script (process_raw_datasets.py)
        singularity run --bind /scratch/aplesner event-datasets.sif

        # Execute a specific script
        singularity exec --bind /scratch/aplesner event-datasets.sif python your_script.py

        # Compile Cython modules (can now run from any directory)
        singularity exec event-datasets.sif python src/setup.py build_ext --inplace
